version: "3.5"

services:

  nextcloud-app:
    image: nextcloud:latest
    restart: always
    volumes:
      - nextcloud-config:/var/www/html/config
      - nextcloud-data:/var/www/html/data
      - nextcloud-apps:/var/www/html/custom_apps
    env_file:
      - ${PWD}/nextcloud/config.env
    environment:
      REDIS_HOST: ${COMPOSE_PROJECT_NAME}_nextcloud-redis_1
      MYSQL_HOST: ${COMPOSE_PROJECT_NAME}_nextcloud-db_1
      NEXTCLOUD_TRUSTED_DOMAINS: traefik
    secrets:
      - nextcloud-admin-password
      - nextcloud-db-password
    depends_on:
      - nextcloud-db
      - nextcloud-redis
    networks:
      - mid-layout
      - back-end
    labels:
      traefik.enable: true
      traefik.docker.network: ${COMPOSE_PROJECT_NAME}_mid-layout
      traefik.http.routers.nas-nextcloud.rule: "Host(`nextcloud.${LOCAL_DOMAIN_NAME}`)"
      traefik.http.routers.nas-nextcloud.service: nas-nextcloud
      traefik.http.services.nas-nextcloud.loadbalancer.server.port: 80

  nextcloud-config:
    image: nextcloud:latest
    restart: on-failure
    volumes:
      - nextcloud-config:/var/www/html/config
      - ./nextcloud/config/:/mnt:ro
    networks: []
    command: bash -c "
      for f in `ls -1 /mnt/*.config.php`; do cat $$f | sed -e 's/{{LOCAL_DOMAIN_NAME}}/${LOCAL_DOMAIN_NAME}/g' > /var/www/html/config/`basename $$f`; done &&
      chown -R www-data:root /var/www/html/config/
      "

  nextcloud-db:
    image: mariadb
    #container_name: nextcloud-db
    command: --transaction-isolation=READ-COMMITTED --binlog-format=ROW
    restart: on-failure
    env_file:
      - ${PWD}/nextcloud/config.env
    secrets:
      - nextcloud-db-password
    volumes:
      - nextcloud-db-mariadb:/var/lib/mysql:consistent
    networks:
      - back-end

  nextcloud-redis:
    image: redis:alpine
    restart: always
    networks:
      - back-end

  nextcloud-cron:
    image: nextcloud:latest
    restart: on-failure
    volumes:
      - nextcloud-config:/var/www/html/config
      - nextcloud-data:/var/www/html/data
      - nextcloud-apps:/var/www/html/custom_apps
    entrypoint: /cron.sh
    env_file:
      - ${PWD}/nextcloud/config.env
    environment:
      REDIS_HOST: ${COMPOSE_PROJECT_NAME}_nextcloud-redis_1
      MYSQL_HOST: ${COMPOSE_PROJECT_NAME}_nextcloud-db_1
    secrets:
      - nextcloud-admin-password
      - nextcloud-db-password
    depends_on:
      - nextcloud-app
      - nextcloud-db
      - nextcloud-redis
    networks: []


volumes:
  nextcloud-db-mariadb:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: "${DATA_FOLDER}/nextcloud/mysql"  # The target path is '/var/lib/mysql'
  nextcloud-config:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: "${DATA_FOLDER}/nextcloud/config"   # /var/www/html/config, predefined setup
  nextcloud-data:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: "${DATA_FOLDER}/nextcloud/data"
  nextcloud-apps:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: "${DATA_FOLDER}/nextcloud/apps"

secrets:
  nextcloud-db-password:
    file: ../secrets/nextcloud/nextcloud-db-passwd.txt
  nextcloud-admin-password:
    file: ../secrets/nextcloud/nextcloud-admin-passwd.txt
