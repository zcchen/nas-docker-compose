version: "3.5"

services:

  nextcloud-db:
    image: mariadb
    container_name: nextcloud-db
    command: --transaction-isolation=READ-COMMITTED --binlog-format=ROW
    restart: on-failure
    environment:
      MYSQL_ROOT_HOST: '%'
      MYSQL_PASSWORD_FILE: /run/secrets/mysql_nextcloud_password
    env_file:
      - ./nextcloud/db.env
    secrets:
      - mysql_nextcloud_password
    volumes:
      - nextcloud-db-mariadb:/var/lib/mysql:consistent
    networks:
      - back_end

  nextcloud-app:
    image: nextcloud:fpm-alpine
    container_name: nextcloud-app
    restart: always
    volumes:
      - nextcloud-wrapper:/var/www/html
      - nextcloud-data:/var/www/html/data
    environment:
      - MYSQL_HOST=nextcloud-db
    env_file:
      - ./nextcloud/db.env
    depends_on:
      - nextcloud-db
    networks:
      - mid_layout
      - back_end

  nextcloud-web:
    build: ./nextcloud/web
    container_name: nextcloud-web
    restart: always
    volumes:
      - nextcloud-wrapper:/var/www/html:ro
    environment:
      - VIRTUAL_HOST=
      - LETSENCRYPT_HOST=
      - LETSENCRYPT_EMAIL=
    depends_on:
      - nextcloud-app
    networks:
      - mid_layout
      - back_end

volumes:
  nextcloud-db-mariadb:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: "${PWD}/data/mysql/nextcloud"
      # The target path is '/var/lib/mysql'
  nextcloud-wrapper:
  nextcloud-data:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: "${PWD}/data/nextcloud/data"
      # The target path is '/var/lib/mysql'

secrets:
  mysql_nextcloud_password:
    file: ./nextcloud/secrets/nextcloud-passwd.txt
